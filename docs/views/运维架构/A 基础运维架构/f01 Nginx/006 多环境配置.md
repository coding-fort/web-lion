在 Linux 系统中，为 Nginx 配置多环境（如测试环境和生产环境）通常需要通过**分离配置文件**或**使用不同端口/域名**来实现环境隔离。以下是详细的实现方案：

## 一、环境规划

假设需求如下：

- **生产环境**：使用域名 `prod.example.com`，端口 `80` 或 `443`（HTTPS），对应项目目录 `/var/www/production`
- **测试环境**：使用域名 `test.example.com`，端口 `8080`（或子域名），对应项目目录 `/var/www/test`

## 二、配置步骤

### 1. 准备项目目录

```bash
# 创建生产环境和测试环境的项目目录
sudo mkdir -p /var/www/production
sudo mkdir -p /var/www/test

# 分别放入对应环境的代码（示例：创建测试页面）
echo "Production Environment" | sudo tee /var/www/production/index.html
echo "Test Environment" | sudo tee /var/www/test/index.html

# 赋予 Nginx 访问权限
sudo chown -R nginx:nginx /var/www
sudo chmod -R 755 /var/www
```

### 2. 配置 Nginx 多环境站点

Nginx 推荐将不同环境的配置文件放在 `/etc/nginx/conf.d/` 目录下（或 `sites-available/` + `sites-enabled/` 结构，视系统而定）。

#### （1）生产环境配置（`/etc/nginx/conf.d/prod.conf`）

```nginx
server {
    listen 80;
    server_name prod.example.com;  # 生产环境域名

    # 生产环境项目根目录
    root /var/www/production;
    index index.html index.php;

    # 日志配置（区分环境日志）
    access_log /var/log/nginx/prod_access.log;
    error_log /var/log/nginx/prod_error.log;

    # 静态资源缓存（生产环境建议开启）
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }

    # PHP 解析（如果需要，生产环境通常启用）
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

#### （2）测试环境配置（`/etc/nginx/conf.d/test.conf`）

```nginx
server {
    listen 8080;  # 测试环境使用不同端口（或子域名 test.example.com:80）
    server_name test.example.com;  # 测试环境域名

    # 测试环境项目根目录
    root /var/www/test;
    index index.html index.php;

    # 日志配置（单独存放测试日志）
    access_log /var/log/nginx/test_access.log;
    error_log /var/log/nginx/test_error.log;

    # 测试环境通常关闭缓存，方便调试
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires -1;  # 不缓存
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # PHP 解析（测试环境可能启用调试模式）
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param APP_ENV test;  # 传递环境变量给应用（如 PHP）
        include fastcgi_params;
    }
}
```

### 3. 验证配置并重启 Nginx

```bash
# 检查配置文件语法是否正确
sudo nginx -t

# 重启 Nginx 使配置生效
sudo systemctl restart nginx
# 或
sudo service nginx restart
```

### 4. 访问测试

- 生产环境：通过 `http://prod.example.com` 访问（需解析域名到服务器 IP）
- 测试环境：通过 `http://test.example.com:8080` 访问（或直接用服务器 IP:8080，如 `http://192.168.1.100:8080`）

## 三、进阶配置（可选）

### 1. 使用 HTTPS 分离环境

生产环境建议启用 HTTPS，测试环境可保持 HTTP：

```nginx
# 生产环境 HTTPS 配置（prod.conf）
server {
    listen 443 ssl;
    server_name prod.example.com;

    ssl_certificate /etc/nginx/ssl/prod.crt;
    ssl_certificate_key /etc/nginx/ssl/prod.key;
    # 其他 SSL 配置...
}
```

### 2. 通过环境变量区分配置

在 Nginx 配置中通过 `fastcgi_param` 或 `proxy_set_header` 传递环境变量给后端应用（如 PHP、Node.js）：

```nginx
# 测试环境传递环境变量
location ~ \.php$ {
    fastcgi_param APP_ENV test;  # 应用可读取此变量判断环境
    # ...
}

# 生产环境传递环境变量
location ~ \.php$ {
    fastcgi_param APP_ENV production;
    # ...
}
```

### 3. 限制测试环境访问（安全措施）

测试环境可通过 IP 白名单限制访问：

```nginx
# 测试环境配置中添加
allow 192.168.1.0/24;  # 允许内部 IP 段访问
deny all;  # 拒绝其他 IP
```

## 四、目录结构说明

推荐的配置文件组织方式：

```
/etc/nginx/
├── nginx.conf          # 主配置
├── conf.d/
│   ├── prod.conf       # 生产环境站点配置
│   └── test.conf       # 测试环境站点配置
├── ssl/                # 证书目录（生产环境用）
└── logs/               # 日志目录（可自定义）
```

通过以上配置，可实现 Nginx 测试环境与生产环境的完全隔离，避免配置冲突，同时方便分别管理日志、缓存策略和访问权限。
